<html>
  <head>
    <style>
      body {
	  margin: 0;
      }
      #bground {
	  background-color: #e3eeff;
	  background-image: linear-gradient(to top right, #f3e7e9 0%, #e3eeff 99%, #e3eeff 100%);
	  padding: 8px;
	  min-height: 100vh;
      }
      #boolean {
	  display: none;
      }
      #ranking {
	  display: none;
      }
      .tiramimage {
	  display: block;
	  margin-left: auto;
	  margin-right: auto;
      }
      .listing {
	  list-style: none;
      }
      .headlines {
	  font-family: Georgia, serif;
      }
      .search-options {
        font-family: Georgia, serif;
        text-align: center;
      }
      .instructions {
	  border: 2px outset MidnightBlue;
	  color: MidnightBlue;
	  background-color: Snow;
	  font-family: Courier New, monospace;
	  font-size: smaller;
	  text-align: center;
	  margin: 50px;
      }
      .results {
	  font-family: Garamond, serif;
      }
      .result-box {
          margin: auto;
          border: 1px solid #ddd;
          background-color: White;
          padding: 10px;
          box-shadow: rgba(0, 0, 0, 0.35) 0px -20px 36px -25px inset;
      }
      .show-less {
          line-height: 2.5;
          max-height: 5em;
          overflow: hidden;
          text-overflow: ellipsis;
	  transition: max-height 2s ease-out;
      }

      .pagination {
          text-align: center
      }

      .pagination .pagination-page {
          padding: 8px 16px;
      }

      .pagination .pagination-page a {
          text-decoration: none;
      }
      .graph-element {
        display: inline-block;
        max-width: 45%;
      }
      input[type=submit], button {
        padding:10px 35px; 
        background:#553c2b;
        color:#EEE;
        font-weight: bold;
        border:0 none;
        cursor:pointer;
        -webkit-border-radius: 5px;
        border-radius: 5px; 
        margin: 4px 0;
      }
      input[type=submit] {
        font-size: larger;
      }
      .tag {
        padding:3px 5px;
        margin: 3px;
        background:#FFF;
        -webkit-border-radius: 5px;
        border-radius: 5px; 
      }
      .result-metadata td {
        padding: 4px;
      }

    </style>
    <meta charset="utf-8">
    <title>TIRAMISU Search Engine</title>
  </head>
  <body>
    <div id="bground">

      <!--Headlines and search options:-->
      <div class="headlines">
	<div class="search-options">
	  <h1 style="color:Teal">TIRAMISU Search Engine</h1>
	  <img src="/static/tiramisu.png" alt="tiramisu ingredients" class="tiramimage">
	  <br><br>
	  <h2 style="color:Teal">Search articles from Archive of Our Own</h2>
	  <!--Explanation of how the search engine works:-->
	  <p>The Tiramisu search engine finds the most relevant articles uploaded on the website Archive of Our Own.
	    <br>For memory reasons the spaCy entity highlighting processes only the first 100 000 characters of each article.
      <br>
	    <br>(insert more general info about the search here...)</p>
	  <br>
	  <form>
	    <!--Search query input:-->
	    <p style="color:#006666"><b>Enter query:</b></p>
	    <input type="text" name="query" value="{{ query }}"autofocus>
	    <br><br>
	    <!--Choosing of search engine:-->
	    <p style="color:#006666">Choose a search engine to see instructions below:</p>
	    <!--Boolean search button:-->
	    <input type="radio" id="boolean_search" name="search_type" value="boolean_search" {% if search_type == "boolean_search" %} checked {% endif %} class="user-info">
            <label for="boolean_search">Boolean search</label>
	    <!--Ranking search button:-->
            <input type="radio" id="ranking_search" name="search_type" value="ranking_search" {% if search_type == "ranking_search" %} checked {% endif %} class="user-info">
            <label for="ranking_search">Relevance ranking search</label>
	    <br><br>
	    <!--Spacy category selection-->
	    <div>
              <p style="color:#006666">Select entities to be highlighted in matching articles:</p>
	      {% for spacy_category in spacy_categories %}
	      <input type="checkbox" id="{{ spacy_category.name }}" name="{{ spacy_category.name }}" value="{{ spacy_category.name }}" {% if spacy_category.active %} checked {% endif %}>
	      <label for="{{ spacy_category.name }}">{{ spacy_category.title }}</label>
	      <!--End for loop-->
	      {% endfor %}
	    </div>
	    <br><br>
	    <!--Search button:-->
	    <input type="submit" value="Search">
	    <br>
	</div>
        </form>
      </div>

      <div class="instructions">
	<!--Show these instructions if boolean search is chosen:-->
	<div id="boolean">
	  <h3>Instructions for Boolean search:</h3>
	  <p>When searching for combinations of words, use operators AND, NOT, OR:
	    <br><i>you AND i
	      <br>example AND NOT solution
	      <br>cat OR horse
	      <br>( NOT example OR test ) AND solution</i>
	    <br><br>
	    Use quotation marks when searching for multi-word phrases (the program only supports bigrams and trigrams):
	    <br><i>"you and i"</i>
	    <br><br>
	    Multi-word phrases can also be combined with the Boolean operators:
	    <br><i>"new york" AND "london"</i>
	    <br><br>
	    Operators AND, OR, NOT need to be written in ALLCAPS, search words in <u>lowercase</u>.</p>
	</div>

	<!--Show these instructions if ranking search is chosen:-->
	<div id="ranking">
	  <h3>Instructions for Relevance ranking search:</h3>
	  <p>When searched for multiple words, separate words with space:
	    <br><i>cat dog horse</i>
	    <br><br>
	    Use quotation marks when searching for multi-word phrases (the program only supports bigrams and trigrams):
	    <br><i>"New York"
	      <br>"you and I"</i>
	    <br><br>
	    Search words can be written in lowercase or uppercase letters.</p>
	</div>
      </div>

      <div class="headlines">
	<!--Error message and matching documents:-->
	<div id="error_message">{{ error }}</div>
	<h3><u>Matching documents</u>:</h3>
	<p><b>{{ docs_total }}</b> matching documents in total.</p>
	{% if plot %}
	<img src="{{ plot }}" class="graph-element">
	{% endif %}
	
      </div>

      <div class="results">
        <!--Go through each item in the "matches" variable sent from
            search() function in the Flask app-->
        {% for item in matches %}
        <div>
          <table class="result-metadata">
            <!--Display the name of the item based on the "name" key-->
            <tr><td><b>Name</b></td><td>{{ item["name"] }}</td></tr>
	    <!--Display relevance score only if ranking search is used:-->
            {% if search_type == "ranking_search" %}
              <tr><td><b>Relevance score</b></td><td>{{ item["score"] }}</td></tr>
            {% endif %}
	    <!--Display categories if present :-->
            {% if item["work"]["categories"] %}
              <tr><td><b>Categories</b></td><td>
                {% for tag in item["work"]["categories"] %}
                  <span class="tag">{{ tag }}</span>
                {% endfor %}
              </td></tr>
            {% endif %}
	    <!--Display characters if present :-->
            {% if item["work"]["characters"] %}
              <tr><td><b>Characters</b></td><td>
                {% for tag in item["work"]["characters"] %}
                  <span class="tag">{{ tag }}</span>
                {% endfor %}
              </td></tr>
            {% endif %}
	    <!--Display fandoms if present :-->
            {% if item["work"]["fandoms"] %}
              <tr><td><b>Fandoms</b></td><td>
                {% for tag in item["work"]["fandoms"] %}
                  <span class="tag">{{ tag }}</span>
                {% endfor %}
              </td></tr>
            {% endif %}
	    <!--Display rating if present :-->
            {% if item["work"]["rating"] %}
              <tr><td><b>Rating</b></td><td><span class="tag">{{ item["work"]["rating"] }}</span></td></tr>
            {% endif %}
	    <!--Display relationships if present :-->
            {% if item["work"]["relationships"] %}
              <tr><td><b>Relationships</b></td><td>
                {% for tag in item["work"]["relationships"] %}
                  <span class="tag">{{ tag }}</span>
                {% endfor %}
              </td></tr>
            {% endif %}
	    <!--Display tags if present :-->
            {% if item["work"]["tags"] %}
              <tr><td><b>General tags</b></td><td>
                {% for tag in item["work"]["tags"] %}
                  <span class="tag">{{ tag }}</span>
                {% endfor %}
              </td></tr>
            {% endif %}
	    <!--Display warnings if present :-->
            {% if item["work"]["warnings"] %}
              <tr><td><b>Warnings</b></td><td>
                {% for tag in item["work"]["warnings"] %}
                  <span class="tag">{{ tag }}</span>
                {% endfor %}
              </td></tr>
            {% endif %}
	    <!--Display date_published if present :-->
            {% if item["work"]["date_published"] %}
              <tr><td><b>Date published</b></td><td><span class="tag">{{ item["work"]["date_published"]|format_date }}</span></td></tr>
            {% endif %}
	    <!--Display date_edited if present :-->
            {% if item["work"]["date_edited"] %}
              <tr><td><b>Date edited</b></td><td><span class="tag">{{ item["work"]["date_edited"]|format_date }}</span></td></tr>
            {% endif %}
	    <!--Display date_updated if present :-->
            {% if item["work"]["date_updated"] %}
              <tr><td><b>Date updated</b></td><td><span class="tag">{{ item["work"]["date_updated"]|format_date }}</span></td></tr>
            {% endif %}
	    </table>
            <!--Display the contents of the item based on the "source" key-->
	    <div class="show-less result-box">{{ item["text"]|safe }}</div>
          </div>
	  <!--End for loop-->
	  {% endfor %}
      </div>
      {% if pages -%}
      <div class="pagination">
        {% for item in pages %}
        <span class="pagination-page">
          {% if item["url"] -%}<a href={{ item["url"]|safe }}>{{ item["name"] }}</a>{% else -%}{{ item["name"] }}{% endif %}
	</span>
        <!--End for loop-->
        {% endfor %}
      </div>
      {% endif %}

    <script>
      // Script for which instructions are shown:
      function userInfo(target) {
          var name = target.id
	  if (name == "boolean_search") {
	      boolean.style.display = "block"
	      ranking.style.display = "none"
	  }
	  else if (name == "ranking_search") {
	      boolean.style.display = "none"
	      ranking.style.display = "block"
	  }
	  else {
	      boolean.style.display = "none"
	      ranking.style.display = "none"
	  }
      }


      // Script for read-more button:
      function showAll(event) {
          if (!event.target.matches('.read-less')) {
              event.target.parentElement.querySelector('.show-less').style.maxHeight = event.target.parentElement.querySelector('.show-less').scrollHeight;
              event.target.classList.add('read-less')
              event.target.innerHTML = "Read less";
          } else {
              event.target.parentElement.querySelector('.show-less').style.maxHeight = null;
              event.target.classList.remove('read-less')
              event.target.innerHTML = "Read more";
          }
      }
      
      (function() {
          // connect all event listeners
          document.addEventListener('click', function (event) {
              if (event.target.matches('.read-more'))
                  showAll(event);
              if (event.target.matches('.user-info'))
                  userInfo(event.target);
          });

          // check userInfo current state to show correct instructions
          userInfo(document.querySelector('.user-info:checked'));
          const documentDivs = document.querySelectorAll(".show-less");

          // create read more buttons for documents needing it
          documentDivs.forEach((documentDiv) => {
              if (documentDiv.scrollHeight > documentDiv.clientHeight + 2) {
                  const button = document.createElement("button");
                  button.innerHTML = "Read more";
                  button.classList.add("read-more");
                  documentDiv.parentNode.insertBefore(button, documentDiv.nextSibling);
              }
          });
	  
      })();
    </script>
    
    </div>
  </body>
</html>
